# Task Card: Симуляция полета дрона-квадракоптера с 3D визуализацией

## Описание задачи

Создать интерактивную симуляцию полета дрона-квадракоптера с 3D визуализацией, включающую:
- Физическую модель дрона с настраиваемыми параметрами
- Систему стабилизации на основе уравнений Ляпунова
- Реакцию на внешние воздействия (ветер, толчки, препятствия)
- UI для управления параметрами и запуска симуляции

## Технический стек

- **Язык**: JavaScript (ES6+)
- **3D библиотека**: Three.js
- **Структура**: Модульная архитектура (классы и модули)

## Структура проекта

```
ai-simu/
├── index.html              # Основной HTML файл с UI
├── css/
│   └── style.css          # Стили для UI
├── js/
│   ├── drone.js           # Класс дрона с физической моделью
│   ├── simulation.js      # Основной класс симуляции
│   ├── lyapunov.js        # Система стабилизации (уравнения Ляпунова)
│   ├── externalForces.js  # Система внешних воздействий
│   ├── visualization.js   # Three.js визуализация
│   └── ui.js              # Управление UI и параметрами
├── package.json           # Зависимости (если нужен npm)
└── README.md              # Документация проекта
```

## Подзадачи

### Этап 1: Базовая структура проекта
**Приоритет**: Высокий
**Статус**: ⬜ Не начато

- [ ] Создать структуру файлов и директорий
- [ ] Настроить `index.html` с базовым UI (панели параметров, кнопки управления)
- [ ] Подключить Three.js (CDN или npm)
- [ ] Создать базовую 3D сцену с камерой и освещением
- [ ] Настроить CSS для красивого UI

**Критерии готовности**:
- Открывается HTML страница с UI
- Отображается пустая 3D сцена с возможностью управления камерой

---

### Этап 2: Физическая модель дрона
**Приоритет**: Высокий
**Статус**: ⬜ Не начато

- [ ] Создать класс `Drone` с параметрами:
  - Масса (mass)
  - Тяга одного двигателя (motorThrust)
  - Расстояние между двигателями (motorDistance)
  - Момент инерции (inertia)
- [ ] Реализовать состояние дрона:
  - Позиция (position: Vector3)
  - Скорость (velocity: Vector3)
  - Ориентация (rotation: Euler - roll, pitch, yaw)
  - Угловая скорость (angularVelocity: Vector3)
- [ ] Реализовать систему 4 двигателей
- [ ] Реализовать уравнения движения:
  - F = ma (линейное движение)
  - τ = Iα (вращательное движение)
- [ ] Метод `update(dt, forces, torques)` для обновления состояния

**Критерии готовности**:
- Дрон может изменять позицию и ориентацию при приложении сил и моментов
- Физика работает корректно (проверить на простых тестах)

---

### Этап 3: Система стабилизации (уравнения Ляпунова)
**Приоритет**: Высокий
**Статус**: ⬜ Не начато

- [ ] Создать класс `LyapunovController`
- [ ] Реализовать PID контроллер для позиции:
  - Пропорциональный коэффициент (kp)
  - Дифференциальный коэффициент (kd)
  - Интегральный коэффициент (ki)
- [ ] Реализовать PID контроллер для ориентации
- [ ] Реализовать функцию Ляпунова V(x) для анализа устойчивости
- [ ] Метод `computeControl(drone, targetPosition, targetRotation)`:
  - Вычисляет необходимые силы и моменты для стабилизации
  - Учитывает текущее состояние и целевое состояние
- [ ] Интеграция с классом `Drone`

**Критерии готовности**:
- Дрон может стабилизироваться в заданной позиции и ориентации
- Система устойчива при малых возмущениях

---

### Этап 4: Внешние воздействия
**Приоритет**: Средний
**Статус**: ⬜ Не начато

- [ ] Создать класс `ExternalForces`
- [ ] Реализовать систему ветра:
  - Скорость ветра (windSpeed)
  - Направление ветра (windDirection)
  - Метод `getWindForce()` - возвращает силу ветра
- [ ] Реализовать систему толчков:
  - Частота толчков (impulseFrequency)
  - Интенсивность толчков (impulseIntensity)
  - Метод `getImpulseForce(time)` - возвращает импульсную силу
- [ ] Реализовать систему препятствий:
  - Проверка коллизий с посторонними предметами
  - Метод `checkCollisions(drone)` - возвращает силу от столкновения
- [ ] Интеграция с симуляцией

**Критерии готовности**:
- Ветер влияет на дрон
- Толчки происходят с заданной частотой
- Коллизии обрабатываются корректно

---

### Этап 5: UI и управление параметрами
**Приоритет**: Средний
**Статус**: ⬜ Не начато

- [ ] Создать класс `UIManager`
- [ ] Панель параметров дрона:
  - Поле ввода: Масса (кг)
  - Поле ввода: Тяга двигателя (Н)
  - Поле ввода: Расстояние между двигателями (м)
- [ ] Панель внешних воздействий:
  - Поле ввода: Скорость ветра (м/с)
  - Поле ввода: Направление ветра (градусы)
  - Поле ввода: Частота толчков (раз/сек)
  - Поле ввода: Интенсивность толчков (Н)
  - Чекбокс: Включить препятствия
- [ ] Кнопки управления:
  - Старт/Стоп симуляции
  - Сброс позиции
  - Пауза
- [ ] Валидация входных данных
- [ ] Связь UI с симуляцией

**Критерии готовности**:
- Можно задать все параметры через UI
- Кнопки управления работают корректно
- Изменения параметров применяются к симуляции

---

### Этап 6: 3D визуализация
**Приоритет**: Высокий
**Статус**: ⬜ Не начато

- [ ] Создать класс `Visualization`
- [ ] Создать 3D модель дрона:
  - Рама (центральное тело)
  - 4 двигателя (цилиндры или сферы)
  - Пропеллеры (опционально, с анимацией)
- [ ] Настроить сцену:
  - Scene, PerspectiveCamera, WebGLRenderer
  - Освещение (AmbientLight + DirectionalLight)
  - OrbitControls для управления камерой
- [ ] Реализовать обновление модели:
  - Синхронизация позиции дрона с 3D моделью
  - Синхронизация ориентации (roll, pitch, yaw)
- [ ] Добавить систему координат (опционально)
- [ ] Добавить визуализацию сил (опционально, стрелки)
- [ ] Оптимизация производительности (60 FPS)

**Критерии готовности**:
- Дрон визуализируется в 3D
- Движение дрона отображается плавно и корректно
- Камера управляется мышью

---

### Этап 7: Интеграция и основной цикл симуляции
**Приоритет**: Высокий
**Статус**: ⬜ Не начато

- [ ] Создать класс `Simulation`
- [ ] Объединить все компоненты:
  - Drone
  - LyapunovController
  - ExternalForces
  - Visualization
  - UIManager
- [ ] Реализовать основной цикл симуляции:
  - requestAnimationFrame для плавной анимации
  - Фиксированный шаг времени для физики (dt)
  - Интеграция методом Эйлера или Рунге-Кутта
- [ ] Последовательность обновления:
  1. Вычисление внешних сил
  2. Вычисление управляющих сил (стабилизация)
  3. Обновление физики дрона
  4. Обновление визуализации
- [ ] Обработка старт/стоп/пауза

**Критерии готовности**:
- Симуляция запускается и работает плавно
- Все компоненты взаимодействуют корректно
- Производительность достаточна для 60 FPS

---

### Этап 8: Тестирование и оптимизация
**Приоритет**: Средний
**Статус**: ⬜ Не начато

- [ ] Протестировать различные сценарии:
  - Стабилизация в покое
  - Реакция на ветер
  - Реакция на толчки
  - Столкновения с препятствиями
- [ ] Проверить корректность физики
- [ ] Оптимизировать производительность
- [ ] Исправить найденные баги
- [ ] Улучшить UI/UX
- [ ] Добавить обработку ошибок

**Критерии готовности**:
- Все функции работают стабильно
- Нет критических багов
- Производительность удовлетворительная

---

## Математические модели

### Уравнения движения дрона

**Линейное движение:**
```
F_total = Σ(F_motors) + F_gravity + F_external
a = F_total / m
v = v + a * dt
p = p + v * dt
```

**Вращательное движение:**
```
τ_total = Σ(τ_motors) + τ_external
α = τ_total / I
ω = ω + α * dt
θ = θ + ω * dt
```

### Система стабилизации (PID контроллер)

**Для позиции:**
```
error = target_position - current_position
F_control = kp * error + kd * d(error)/dt + ki * ∫error dt
```

**Для ориентации:**
```
error = target_rotation - current_rotation
τ_control = kp * error + kd * d(error)/dt + ki * ∫error dt
```

### Функция Ляпунова

```
V(x) = 0.5 * (||position_error||² + ||rotation_error||² + ||velocity||² + ||angular_velocity||²)
```

Для устойчивости: `dV/dt < 0`

---

## Параметры по умолчанию

### Дрон
- Масса: 1.0 кг
- Тяга одного двигателя: 2.5 Н (максимум)
- Расстояние между двигателями: 0.25 м
- Момент инерции: вычисляется автоматически

### Внешние воздействия
- Скорость ветра: 0 м/с
- Направление ветра: 0° (по оси X)
- Частота толчков: 0.5 раз/сек
- Интенсивность толчков: 5 Н

### Контроллер стабилизации
- kp (позиция): 10.0
- kd (позиция): 5.0
- ki (позиция): 0.1
- kp (ориентация): 8.0
- kd (ориентация): 4.0
- ki (ориентация): 0.05

---

## Критерии приемки (Definition of Done)

✅ Проект считается завершенным, когда:
1. Все этапы выполнены и протестированы
2. UI позволяет задавать все необходимые параметры
3. Симуляция запускается и работает стабильно
4. Дрон реагирует на внешние воздействия
5. Система стабилизации работает корректно
6. 3D визуализация отображает состояние дрона в реальном времени
7. Производительность достаточна для плавной работы (60 FPS)
8. Код структурирован и документирован

---

## Дополнительные улучшения (опционально)

- [ ] Графики параметров (позиция, скорость, углы) в реальном времени
- [ ] Сохранение/загрузка конфигураций параметров
- [ ] Различные режимы камеры (слежение за дроном, свободная камера)
- [ ] Визуализация траектории полета
- [ ] Звуковые эффекты
- [ ] Более детальная 3D модель дрона
- [ ] Физика пропеллеров (визуальная анимация)
- [ ] Экспорт данных симуляции

---

## Примечания

- Использовать фиксированный шаг времени для физики (например, 1/60 секунды) для стабильности
- Учитывать ограничения двигателей (максимальная тяга)
- Обрабатывать граничные случаи (слишком большие силы, деление на ноль и т.д.)
- Код должен быть читаемым и хорошо структурированным

---

**Дата создания**: 2024
**Статус проекта**: ⬜ Не начато
**Прогресс**: 0/8 этапов

